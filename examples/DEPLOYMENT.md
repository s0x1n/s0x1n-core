# Example Deployment Repository

This is a minimal example of how to use the nixos-foundation-lib in your deployment repository.

## Structure

```
my-nixos-config/
├── flake.nix
└── hosts/
    └── myhost/
        ├── configuration.nix
        └── hardware-configuration.nix (generated by nixos-generate-config)
```

## Quick Start

1. **Create your flake.nix**:

```nix
{
  description = "My NixOS Configuration";

  inputs = {
    nixpkgs.url = "github:NixOS/nixpkgs/nixos-unstable";
    
    foundation = {
      url = "github:yourusername/nixos-foundation-lib";
      inputs.nixpkgs.follows = "nixpkgs";
    };
  };

  outputs = { self, nixpkgs, foundation }: {
    nixosConfigurations.myhost = nixpkgs.lib.nixosSystem {
      system = "x86_64-linux";
      modules = [
        ./hosts/myhost/configuration.nix
      ];
      specialArgs = { inherit foundation; };
    };
  };
}
```

2. **Create your configuration.nix**:

```nix
{ config, pkgs, foundation, ... }:

let
  lib = foundation.lib.foundation.storage;
  
  # Disk configuration
  diskConfig = lib.compose {
    device = "/dev/nvme0n1";  # Change to your device
    
    filesystem = lib.filesystems.btrfs {
      subvolumes = {
        root = { mountpoint = "/"; mountOptions = [ "compress=zstd" "noatime" ]; };
        persist = { mountpoint = "/persist"; mountOptions = [ "compress=zstd" "noatime" ]; };
        nix = { mountpoint = "/nix"; mountOptions = [ "compress=zstd" "noatime" ]; };
        snapshots = { mountpoint = "/.snapshots"; mountOptions = [ "compress=zstd" "noatime" ]; };
      };
    };
    
    encryption = lib.encryption.luksYubikey {
      method = "fido2";
      passwordFallback = true;
    };
    
    swapSize = "8G";
  };
  
  # Impermanence configuration
  impermanenceConfig = lib.impermanence {
    persistPath = "/persist";
    users.myuser = {};
  };

in {
  imports = [
    ./hardware-configuration.nix
    diskConfig
    impermanenceConfig.system
  ];

  # Basic system configuration
  boot.loader.systemd-boot.enable = true;
  boot.loader.efi.canTouchEfiVariables = true;

  networking.hostName = "myhost";
  networking.networkmanager.enable = true;

  time.timeZone = "America/New_York";

  users.users.myuser = {
    isNormalUser = true;
    extraGroups = [ "wheel" "networkmanager" ];
    hashedPassword = "$6$...";  # Use mkpasswd to generate
  };

  # Home-manager integration
  home-manager = {
    useGlobalPkgs = true;
    useUserPackages = true;
    users.myuser = {
      imports = [ impermanenceConfig.home.myuser ];
      
      home.stateVersion = "25.05";
      
      # Your home-manager config here
    };
  };

  system.stateVersion = "25.05";
}
```

3. **Install**:

```bash
# Format and partition (disko handles this)
sudo nix run github:nix-community/disko -- --mode disko --flake .#myhost

# Install NixOS
sudo nixos-install --flake .#myhost

# After first boot, enroll your YubiKey
sudo systemd-cryptenroll --fido2-device=auto /dev/nvme0n1p2
```

## User Config Location

Since you want your config in `~/.config/nixos/`:

```bash
# Clone your config
mkdir -p ~/.config
git clone https://github.com/yourusername/my-nixos-config ~/.config/nixos

# Rebuild
sudo nixos-rebuild switch --flake ~/.config/nixos#myhost
```

The config will persist because your home directory persists!
